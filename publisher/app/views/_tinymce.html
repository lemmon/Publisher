<script src="{{ link.vendor('tiny_mce/tiny_mce.js') }}" type="text/javascript" charset="utf-8"></script>
<link rel="stylesheet" type="text/css" href="{{ link.publisher('admin/css/forms_tinymce.css') }}">
<script type="text/javascript" charset="utf-8">
$(function(){
	// tinymce
	tinyMCE.init({
		mode : 'textareas',
		theme : 'advanced',
		skin : 'lepublisher',
		setup : function(ed){
			ed.onInit.add(function(ed, e){
				var dom = ed.dom,
				    doc = ed.getDoc();
				// on focus/blur
				tinymce.dom.Event.add(doc, 'focus', function(e){
					$(ed.getContainer()).addClass('focus');
				});
				tinymce.dom.Event.add(doc, 'blur', function(e){
					$(ed.getContainer()).removeClass('focus');
				});
				// on image resize
				tinymce.dom.Event.add(doc, 'mouseup', function(e){
					var mySelection = tinyMCE.activeEditor.selection.getNode();
					if (mySelection.tagName == 'IMG'){
						mySelection.src = mySelection.src.replace(/(\/0\d*x\d*\w*)?\/media\//, '/0' + $(mySelection).width() + 'xm/media/');
						$(mySelection).removeAttr('_mce_src').removeAttr('height');
					}
				});
				//
				$('#' + ed.editorContainer).find('iframe').contents().find('body')
					.find('div.image').removeAttr('style').removeAttr('_mce_style');

				//var $body = $('#' + ed.editorContainer).find('iframe').contents().find('body');
			});
			// insert image button
			ed.addButton('myinsertimage', {
				title : 'Insert Image',
				onclick : function() {
					ed.focus();
					$('.popup').show();
					return;
				}
			});
		},
		element_format : 'html',
		plugins : 'paste',
		height : '480',
		theme_advanced_buttons1 : 'bold,italic'
			+ ',|,bullist,numlist'
			+ ',|,myinsertimage,justifyleft,justifycenter,justifyright'
			+ ',|,link,unlink,|,undo,redo'
			+ ',|,cleanup,removeformat,|,styleselect,|,code',
		theme_advanced_buttons2 : '',
		theme_advanced_buttons3 : '',
		theme_advanced_toolbar_location : 'top',
		theme_advanced_toolbar_align : 'left',
		theme_advanced_path_location : 'bottom',
		theme_advanced_resizing : true,
		theme_advanced_resize_horizontal : false,
		content_css : '{{ link.publisher('admin/css/tinymce.css') }}',
		formats : {
			alignleft : {selector : 'div.image', classes : 'left'},
			aligncenter : {selector : 'div.image', classes : 'center'},
			alignright : {selector : 'div.image', classes : 'right'}
		},
		style_formats : [
			{title : 'Heading', block : 'h3'},
			{title : 'Subheading', block : 'h4'},
			{title : 'Paragraph', block : 'p'}
		],
		fix_list_elements : true,
		valid_elements : 'p,strong/b,em/i,br,h3,h4,ul,ol,li,blockquote,dl,dt,dd,a[href|target]'
			+ ',div[class]'
			+ ',img[src|width|height|class<left?right]'
			+ ',iframe[width|height|src|frameborder:0|allowfullscreen]',
		entity_encoding : 'raw',
		convert_urls : false
	});
	//
	$('form:has(textarea)').submit(function(){
		$('.mceEditor').each(function(){
			var $body = $(this).find('iframe').contents().find('body');
			while ($body.find(':not(img):empty').size()){
				$body.find(':not(img):empty').remove();
			}
			$body.find('img').removeAttr('_mce_src').removeAttr('height');
		});
	});
});
function getRootNode(node){
	while (node) {
		if (node.parentNode && node.parentNode.nodeName == 'BODY') { return node; }
		else { node = node.parentNode; }
	}
	return null;
}
function insertImage(id, src){
	var myNode = getRootNode(tinyMCE.activeEditor.selection.getNode()),
	    toInsert = '<div class="image center" rel="' + id + '"><img src="' + src.replace(/uploads(\/0[^\/]+)?/, 'uploads/0800xm') + '"></div>';
	if (!myNode){
		$(tinyMCE.activeEditor.getDoc().documentElement).find('body').prepend(toInsert);
	} else{
		$(myNode).before(toInsert);
	}
	$('.popup').hide();
}
</script>
