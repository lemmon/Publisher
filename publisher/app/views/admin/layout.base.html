{% extends 'boilerplate.html' %}

{% block head_append %}
<link rel="stylesheet" href="{{ link.publisher('admin/css/master.css') }}">
{% endblock %}

{% block body %}

    {% include '_notices.html' %}

    <div id="container">

        {% block main %}
        {% endblock %}
    
    </div>
    
    <div id="modal-overlay"></div>
    <div id="modal-window"><iframe name="modal" src=""></iframe></div>

    <script src="{{ link.jQuery }}"></script>
    <script src="{{ link.vendor('select2/select2.min.js') }}"></script>
    <script>
    //
    // location
    var section = location.pathname.substring(7),
        sectionThis = section.split('/')[0],
        sectionIn = parent.location.pathname.substring(7).split('/')[0];
    if (window.name != 'modal' && window != top.window){
        top.location = top.location.href.split('#')[0] + '#' + section + (sectionIn && sectionThis != sectionIn ? '/in/' + sectionIn : '');
    }
    //
    // others
    var $modalOverlay,
        $modalWindow,
        $modalWindowIframe;
    $(function(){
        
        var $notices = $('#notices');
        
        //
        // title
        if (window != top.window){
            var $titleThis = $('title'),
                $titleTop = $(top.document).find('title'),
                titleThis = $titleThis.text(),
                titleTop = $titleTop.text().split(' | ')[0];
            $titleTop.text(titleTop + (titleThis ? ' | ' + titleThis : ''));
        }
        
        //
        // tabs
        $('.tabs').each(function(){
            var $list = $(this),
                $tabs = $list.nextAll('.tab');
            $list.find('a').each(function(i){
                var $this = $(this);
                $this.click(function(){
                    $this.addClass('active').siblings('.active').removeClass('active');
                    $tabs.filter(':not(:eq(' + i + '))').hide();
                    $tabs.filter(':eq(' + i + ')').show();
                    return false;
                });
            }).filter(':first').click();
        });
        
        //
        // forms submit
        $('form').each(function(){
            var $form = $(this),
                isRedir = false;
            // form submit
            $form.submit(function(){
                // parse editareas
                $form.find('div[rel=article]').remove();
                $form.find('article.edit').each(function(){
                    var $this = $(this),
                        $article = $this.clone(),
                        $fields = $('<div rel="article"></div>').insertAfter($this),
                        name = $this.data('name');
                    // sanitize html
                    $article.children('.html').replaceWith(function(){ return $(this).html() });
                    $('<input>', {
                        type: 'hidden',
                        name: 'blocks[' + name + ']',
                        value: $article.html()
                    }).appendTo($fields);
                });
                // clear error notices
                $notices.find('.error').remove();
                $notices.children().hide();
                // button loading state
                $form.find('button:first').attr('disabled', true).addClass('loading');
            });
            // form result
            $form.find('iframe[name=form-frame]').load(function(){
                var $this = $(this),
                    res = $this.contents().text();
                // try to parse result
                try{
                    res = $.parseJSON(res);
                }catch (e){
                    res = {};
                }
                // process result
                $form.find('.error').removeClass('error').find('.hint').show();
                $form.find('.errormsg').remove();
                if (res.flash && res.flash.errors){
                    // on error
                    $notices.html('<div class="flash error">' + res.flash.errors.join('<br>') + '</div>');
                    $.each(res.flash.fields, function(field, messages){
                        var $p = $('[rel=f_' + field + ']');
                        $p.addClass('error');
                        if (messages){
                            $p.find('.hint').hide();
                            $p.append('<span class="errormsg">' + messages.join('<br>') + '</span>');
                        }
                    });
                    //alert(res.flash.errors.join('<br>'));
                }else if (res.redir){
                    if ($form.data('success') == 'true'){
                        $form.trigger('success', [res]);
                    }else{
                        var redir = res.redir.replace(/^\/\w+\//, '');
                            toSection = redir.match(/[^\/]+/)[0],
                            to = top.location.pathname + '#' + redir + ((sectionIn && sectionThis != sectionIn ? '/in/' + sectionIn : '') || (toSection != sectionThis ? '/in/' + sectionThis : ''));
                        top.location = to;
                        top.refresh(true);
                        isRedir = true;
                    }
                }
                // return buttons to normal states
                if (!isRedir){
                    $form.find('button:first').removeClass('loading').attr('disabled', false);
                }
                //
                return false;
            });
        });
        
        //
        // modal
        $modalOverlay = $('#modal-overlay');
        $modalWindow = $('#modal-window')
        $modalWindowIframe = $modalWindow.find('iframe');
        $modalOverlay.click(function(){
            modalHide();
        });
        
    });
    //
    // modal
    function modalShow(url){
        $modalOverlay.show();
        $modalWindowIframe.load(function(){
            $modalWindow.show();
            $modalWindowIframe.unbind('load');
        }).attr('src', url);
    }
    function modalHide(){
        $modalOverlay.hide();
        $modalWindow.hide();
        $modalWindowIframe.attr('src', 'about:blank');
    }
    </script>
    {% block script %}{% endblock %}
    
{% endblock %}
