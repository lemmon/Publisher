{% extends 'boilerplate.html' %}

{% block head_append %}
<link rel="stylesheet" href="{{ link.publisher('admin/css/master.css') }}">
{% endblock %}

{% block body %}

    {% include '_notices.html' %}

    <div id="container">

        {% block main %}
        {% endblock %}
    
    </div>
    
    <div id="modal-overlay"></div>
    <div id="modal-window"><iframe name="modal" src=""></iframe></div>

    <script src="{{ link.jQuery }}"></script>
    <script src="{{ link.publisher('admin/js/layout.js') }}"></script>
    <script>
    $(function(){
        
        
        //
        // forms submit
        $('form').each(function(){
            var $form = $(this),
                isRedir = false;
            // form submit
            $form.submit(function(){
                // parse editareas
                $form.find('div[rel=article]').remove();
                $form.find('article.edit').each(function(){
                    var $this = $(this),
                        $article = $this.clone(),
                        $fields = $('<div rel="article"></div>').insertAfter($this),
                        name = $this.data('name');
                    // sanitize html
                    $article.children('.html').replaceWith(function(){ return $(this).html() });
                    $('<input>', {
                        type: 'hidden',
                        name: 'blocks[' + name + ']',
                        value: $article.html()
                    }).appendTo($fields);
                });
                // clear error notices
                $notices.find('.error').remove();
                $notices.children().hide();
                // button loading state
                $form.find('button:first').attr('disabled', true).addClass('loading');
            });
            // form result
            $form.find('iframe[name=form-frame]').load(function(){
                var $this = $(this),
                    res = $this.contents().text();
                // try to parse result
                try {
                    res = $.parseJSON(res);
                } catch (e) {
                    res = {};
                }
                // process result
                $form.find('.error').removeClass('error').find('.hint').show();
                $form.find('.errormsg').remove();
                if (res.flash && res.flash.errors){
                    // on error
                    $notices.html('<div class="flash error">' + res.flash.errors.join('<br>') + '</div>');
                    $.each(res.flash.fields, function(field, messages){
                        var $p = $('[rel=f_' + field + ']');
                        $p.addClass('error');
                        if (messages) {
                            $p.find('.hint').hide();
                            $p.append('<span class="errormsg">' + messages.join('<br>') + '</span>');
                        }
                    });
                    //alert(res.flash.errors.join('<br>'));
                }else if (res.redir){
                    if ($form.data('success') == 'true') {
                        $form.trigger('success', [res]);
                    } else {
                        var redir = res.redir.replace(/^\/\w+\//, '');
                            toSection = redir.match(/[^\/]+/)[0],
                            toHash = '#!' + redir + ((sectionIn && sectionThis != sectionIn ? '/in/' + sectionIn : '') || (toSection != sectionThis ? '/in/' + sectionThis : ''));
                        top.location.hash = to;
                        top.refresh(true);
                        isRedir = true;
                    }
                }
                // return buttons to normal states
                if (!isRedir) {
                    $form.find('button:first').removeClass('loading').attr('disabled', false);
                }
                //
                return false;
            });
        });
        
    });
    </script>
    {% block script %}{% endblock %}
    
{% endblock %}
